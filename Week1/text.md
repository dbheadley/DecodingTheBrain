# Week 1

## Syllabus and class structure
Welcome to the course *Decoding the Brain*. We will cover how to process electrical signals generated by neural activity, use machine learning approaches to infer the presentation of stimuli or an intended motor action from that activity, and evaluate the performance of these inferences. 

The is designed so that students gain a practical understanding of how to design the algorithms used for brain-computer interfaces (BCI). By the end of the course, you should understand enough to program your own BCI algorithms for non-invasive (scalp) and invasive (electrodes implanted in the brain) measures of brain activity. These activities can be weak electrical activity recorded from the scalp (EEG), high-frequency oscillations recorded on the brain surface (ECoG), and the firing of individual neurons (units). Decoding each of these types of signals requires several steps we will cover. First, you will be shown how to process and clean them for subsequent decoding. Then, we will cover the theory behind how the decoding algorithms work and code basic versions of them from scratch in Python. Next, we will expand their capabilities to handle more complex patterns of brain activity or decode multiple events. Finally, we will evaluate the decoder's performance.

Except for cursory discussion, we will not cover the hardware, surgical, and biocompatibility issues of recording brain activity. Those topics depend upon a fundamentally different skill-set from the design of BCI algorithms. 

The two principal algorithms covered in this course, logistic regression and naive Bayes, are useful outside of BCIs. Thus, the understanding you get of them here will apply to many other domains.

## Basic neurophysiology
The brain is an electro-chemical machine that allows vertebrates to interact with a dynamic complex environment. It does this using specialized cells called *neurons*. They have the ability to receive chemical signals, *neurotransmitters*, that affect their electrical activity. This activity is transmitted to other neurons via an *axon*. When multiple neurons are connected together they form a network that supports the transformation of incoming activity and spontaneous generation of new activites.

### Brain anatomy
Multiple structural/circuit levels
SCALP -> SKULL -> ARACHNOID/DURA/PIA -> BRAIN

### Neurons
Neurons are the principal cell type in the brain for processing information. Neurons are tiny, ~10 microns, which is 5-10 times smaller than the diameter of a human hair. They are comprised of a soma (cell body), dendrites, and an axon. The dendrites take in signals from other neurons, integrate them, and convey them to the soma. When these signals exceed a threshold, the soma can generate an *action potential* that is conveyed down the axon towards other neurons. 

### Electrical behavior of membranes
Like all eukaryotic cells, neurons have a lipid membrane that seals in their internal, or *intracellular*, fluid (also known as cytoplasm) and organelles from the *extracellular* environment. This membrane also acts as an electrical insulator, blocking the flow of electrical charges across it. Electrical charge in the brain is carried by *ions* in the intracellular and extracellular fluids (cerebrospinal fluid). Ions are atoms that can be either positively or negatively charged depending on whether they have a fewer or greater number of electrons than protons. The ones that are most determinative of neural activity are Na<sup>+</sup>, K<sup>+</sup>, Cl<sup>-</sup>, and Ca<sup>2+</sup>. Between the intracellular and extracellular fluids, the concentrations of these ions are different. Na<sup>+</sup>,Cl<sup>-</sup>, and Ca<sup>2+</sup> have higher concentrations in the extracellular fluid, while K<sup>+</sup> ions have a higher concentration in the intracellular fluid. 

```python
# Dataframe of ionic properties
ion_props = pd.DataFrame({'Ion': ['Na', 'K', 'Cl', 'Ca'],
                          'Out_mM': [140, 3, 140, 1.5],
                          'In_mM': [7, 140, 7, 0.0001],
                          'Charge': [1, 1, -1, 2]})
ion_props.set_index('Ion', inplace=True)
```


This uneven distribution of ions across the membrane is unstable because ions tend to flow from where they are highly concentrated to where they are less concentrated. To cross the membrane, ions flow through channels, unsurprisingly called *ion channels*. These are proteins that span the inside and outside of the neuron with a central hole through which the ions flow. The pore's shape and charge determine its selectivity for specific ionic species. Additional factors can control the opening of the pore. Some ion channel pores are controlled by the voltage across the membrane, others by substances such as neurotransmitters or hormones that bind to them, or even other ions like Mg<sup>2+</sup>.

Since ions move from high to low concentrations, Na<sup>+</sup>, Cl<sup>-</sup>, and Ca<sup>2+</sup> are inclined to flow into neurons. K<sup>+</sup>, on the other hand, wants to flow out of the neuron. As these ions flow through the membrane they build up on its surface. This create a force that opposes further flow from diffusion, because ions with the same sign to their charge tend to push away from each other. The work needed to move a charge from one place to another is measured as a *voltage* or *potential*. The potential at which an ion's electrical forces from the buildup of ions balance out the diffusion force is referred to as the *reversal potential*, E<sub>ion</sub>. In the case here, we are measuring potential between the inside and outside of the neuron. We can calculate the strength of the potentials that reflect these drives using the Nernst equation.

$$E_{ion} = \frac{RT}{z_{ion}F}ln\frac{[Ion]_o}{[Ion]_i}$$


```python
# Calculate reversal potential using Nernst equation
def rever_pot(conc_o, conc_i, z, t=310):
    # default temperature, t, is body temperature in Kelvin
    R = 8.314 # ideal gas constant
    F = 96485 # Faraday's constant
    e_r = R*t/(z*F)*np.log(conc_o/conc_i)
    return e_r

ion_props['Er_mV'] = rever_pot(ion_props['Out_mM'], ion_props['In_mM'], ion_props['Charge'])*1000
```

R and F are physical constants, while T is temperature in Kelvin and z<sub>s</sub> is the charge of the ion. [Ion]<sub>o</sub> and  [Ion]<sub>i</sub> are the extracellular and intracellular concentrations of that ion, respectively. Several insights are readily apparent from cursury inspection of this equation. First, and most importantly, positive ions that have a higher concentration outside the neuron will have positive potentials, while those more concentrated inside the neuron have negative potentials. This is stands out when comparing the potential of Na<sup>+</sup>, whose potential is **X** and K<sup>+</sup>, whose potential is -**X**. Second, since we are taking the ratio between [Ion]<sub>o</sub> and  [Ion]<sub>i</sub>, the overall amount of ions in our system does not affect the potential, only their relative proportion. Put another way, you could decrease the concentration of Na<sup>+</sup> ions inside and outside the neuron by ten times and as long as they have the same proportion, the potential will be unchanged. Third, if an ion has a negative charge, z<sub>ion</sub>, it flips the sign of the potential. For instance, Cl<sup>-</sup> ions have a higher concentration outside the neuron, just like Na<sup>+</sup>, but their potential is negative.

The potential across a neuron's membrane is the mean of all these potentials, each weighted by how easy it is for the ion to cross the membrane, which is related to the number of open ion channels allowing that ion to flow. In a neuron at rest, the mostly K<sup>+</sup> ion channels are open, so its reversal potential dominates. Neurons in the cerebral cortex usually have a resting potential around -65 mV. 

### Electrical model of the neuronal membrane
The electrical behavior of the membrane can be approximated by a relatively simple circuit. While this is not an electronics course, I will briefly describe this model and use it to construct a simulated neuron. This should allow us to explore some of the response properties of neurons and how they are reflected in the electrical activities detected with electrodes.

#### **Reversal potential as a battery**
The reversal potential across the membrane behaves like a battery, with a steady voltage across the membrane. This can be schematized below as a battery spanning the intracellular and extracellular spaces.

BATTERY DIAGRAM

#### **Membrane as a capacitor**
The neuron's membrane is conceived of as a capacitor (see https://doi.org/10.1016/S0006-3495(00)76293-X for more info). These devices are an insulator sandwiched between two conductors, in our case the lipid membrane acts as the insulator since charge cannot cross it, and the extracellular and intracellular ionic solutions are the conductors. Since each charge puts out an electric field attracts the opposite charge and repels the same charge, and this field decays with distance from the charge, the thinner the insulator is the stronger charges on either side of it can influence each other. If positive charges build up on one side of the capacitor, then they will draw negative charges to build up on the opposite side. The ability of a capacitor to store charge is quantified by its capacitance:

$$ C = \frac{\epsilon\epsilon_{0}A}{d} $$

where $\epsilon$ is the dielectric constant of the insulation material, $\epsilon_{0}$ is the polarizability of free space, $A$ is the surface area of the capacitor, and $d$ is the thickness of the insulator. Capacitance is measured in the units Farads (F). This equation tells us that to increase capcitance one should enlarge the surface area of the capacitor, allowing more space to accomodate charge, and shrink the thickenss of the insulator, making it easier for charges on either side to interact. 

What value does the capacitance take for neurons? Since all membranes are composed of a lipid bilayer, they do not differ in their material composition so their $\epsilon$ stays the same, and $\epsilon_{0}$ is a physical constant that does not change. The thickness of the neuronal membrane, $d$, our insulator, is also consistent across neurons, with a value ~9 nm. But, since neurons can vary in size, $A$ varies greatly across neurons. So, we often use the term 'specific capacitance', which is the ratio between capacitance and area. The standard value of this is 1 uF/cm<sup>2</sup>. If we approximate a neuron as a sphere, then its capacitance can be calculated using its radius to calculate the area of the sphere ($A=4 \pi r^2$), and multiplying that by the 1 uF/cm<sup>2</sup>. For instance, a neuron with a radius of 10 um has a capacitance of 12.5 pF.

Expanding our electrical schematic, we now have the resting potential battery and membrane capacitor in the same circuit in parallel. If you imagine the moment we hook up this circuit, the a current flows that instantly charges up the capacitor so that it has the same voltage as the resting potential battery.

BATTERY CAPACITOR DIAGRAM

The relationship between current and voltage for a capacitor is described by the equation:

$$ I = C\frac{dV}{dt} \tag{1}$$
What this means is that the current is proportional to the change in voltage. When the battery is first connected in the circuit above, the change in voltage virtually infinite, which instantly charges the capacitor up to the same voltage as a resting potential.

INTRODUCE KIRCHOFF'S VOLTAGE LAW

#### **Ion channels as resistors and batteries**
The ion channels that stud the membrane allow ionic currents to flow in and out of the neuron. This can be analogized to two electric components connected in series, one after the other. First, the flow of ions will be restricted by the properties of the ion channel pore, which behaves like an electrical component called a *resistor*. A resistor literally resists the flow of charge, meaning that work has to be done to move a charge across it.  Second, ions are flowing because they have a concentration gradient, which is balanced at their reveral potential we calculated earlier. The reversal potential behaves like a battery. The ionic current can be described using Ohm's law:

$$ V = IR $$
where $V$ is voltage (volts, V), $I$ is current (amperes, A), and $R$ is resistance (ohms, $\Omega$). Rewriting the equation to solve for $I$ gives us:
$$ I = \frac{V}{R} $$
The inverse of resistance is conductance (siemens, S), so this equation can be rewritten as:
$$ I = gV $$
Here g is the conductance. Now, if we include the effect of the reversal potential, $E_{ion}$ acting as a battery, then the equation can be written as:
$$ I_{ion} = g_{ion}(V_{m}-E_{ion}) \tag{2} $$
Let's consider the behavior of this equation. It shows that as we increase the ion channel's conductance, $g_{ion}$, the current will increase as well. It also shows that the magnitude and direction of the current will depend on the membrane voltage, $V_{m}$. If the $V_{m}$ is below the $E_{ion}$, current will be negative. If it is above, then it will be positive. Interestingly, as $V_{m}$ approaches $E_{ion}$, the current gets smaller. When they are equal, no current flows because the electrical forces perfectly balance the concentration gradient. 

```python
# Calculate transmembrane current using Ohm's law
def ionic_current(e_r, g_i, v_mem):
    i = g_i*(e_r-v_mem)
    return i
```

Even when the membrane is at rest, ion channels are spontaneously open. These behave as a resistor, in series with the resting potential battery. Incorporating this into our membrane circuit, we get the now have the passive electrical model of the membrane.

DIAGRAM WITH MEMBRANE CAPACITOR, BATTERY AND RESISTOR IN SERIES.

#### **The passive circuit model of the membrane**
The passive electrical circuit model is also known as an *RC circuit*, because it contains a resistor and capacitor. What is its behavior? When it is first put together, there is no voltage across the capacitor, so the battery will charge it up. However, the resistor places a limit on the current, meaning the capacitory will not fully charge instantly. To determine the trajectory the voltage will take, we can model this with an equation by combining equations 1 and 2 using Kirchoff's current law, which states that the total currents flowing through any part of a circuit must sum to 0. For the circuit above, this yields the equation:
$$ \begin{align} 
    0 &= I_{rest} + I_{C} \\
    &=g_{m}(V_{m}-E_{rest}) + C_{m}\frac{dV}{dt} \\
    -C\frac{dV}{dt}&=g_{m}(V_{m}-E_{rest}) \\
    \frac{dV}{dt}&=-\frac{g_{m}}{C}(V_{m}-E_{rest})
    \end{align}
$$

This is a differential equation that can be solved to give voltage as a function of time:
$$ V(t) = E_{rest}(1-e^{\frac{-t}{\frac{g_{m}}{C_{m}}}}) $$

Rewriting $g_{m}$, as its inverse, referred to as membrane resistance, $R_{m}$, we get the equation:
$$ V(t) = E_{rest}(1-e^{\frac{-t}{R_{m}C_{m}}}) $$

The product of $R_{m}$ and $C_{m}$ sets how fast the membrane charges. Larger it is, the slower the membrane capacitor will charge, and the smaller it is, the faster it charges.


### Synapses
Since neurons form networks that share electrical signals, there must be a means for these signals to be passed from one neuron to another. This exchange occurs at synapses, where the axon from the *presynaptic* neuron forms a terminal on the dendrite of the *postsynaptic* neuron. Between them is a narrow space called the *synaptic cleft*, where neurotransmitters released by the presynaptic terminal crosses to binds to ion channels on the postsynaptic neuron. When the neurotransmitter binds it opens the ion channel, which allows a current composed of the ions that channel is permeable to to flow. Channels that are found at excitatory synapses, which drive the membrane potential towards positive values (depolarize), tend to be permeable positive ions, Na<sup>+</sup>, K<sup>+</sup>, and Ca<sup>2+</sup>. Inhibitory synapses rely on ion channels selective for the negative Cl<sup>-</sup> ion and can counteract the excitatory depolarization.

Cortical neurons are normally bombarded by an ongoing stream of excitatory and inhibitory synaptic activity. Usually these are balanced, so that the membrane potential shows only small changes in its level. However, if the excitatory synaptic drive overwhelms the inhibition it can push the membrane potential towards postive values and potentially trigger an *action potential*.

### Action potentials
Action potentials are large positive excursions of the membrane potential. They last less than 2 ms and propagate from the cell body down the axon, eventually triggering release of neurotransmitter at the synapse. They are the principal output of neurons and, for the most part, the only information about the state of a neuron that is conveyed to the rest of the network.

To generate an action potential, a neuron is first depolarized to a sufficient level that starts to open voltage-gated Na<sup>+</sup> ion channels. Recalling that Na<sup>+</sup> has a positive reversal potential, their opening will depolarize the membrane voltage. This depolarization recruits more voltage-gated Na<sup>+</sup> ion channels, reinforcing the depolarization and driving the membrane potential towards the Na<sup>+</sup> reversal potential. Then, these channels begin to *inactivate*, closing and bringing the membrane back towards its resting potential. This fall back towards rest is accelerated by voltage-dependent K<sup>+</sup> channels, which open during the depolarization of the action potential and drive the membrane towards the K<sup>+</sup> reversal potential (-X).

Action potentials are often described as all-or-none events. Either they occur or they do not, and when they do, they tend to always have the same strength and duration. Since they are stereotyped, it is thought that they convey information by their timing. Several different terms are often used to describe the codes offered by action potentials. A *time code* is when the exact time of an action potential indicates the occurrence of some event (whether it be environmental or behavioral). This is often counterposed to a *rate code*, where the informational signal is the how many action potentials occurred in some short amount of time, with a higher rate indicating a 'stronger' signal. Alternatively, a *population code* uses the set of neurons firing action potentials at any given moment to encode information. Different ensembles of activated neurons signal different events.

## Physics of extracellular potentials
Since each charge produces an electric field, and this field can influence the movement of other charges, the movements of those charges as currents flowing through the membrane during synaptic barrages or action potentials can be detected by nearby electodes. Fortunately for us, these transmembrane currents are so weak and so slow that we can use a simple equation to describe their influence on the voltage picked up by a nearby electrode. This is given by Poisson's equation:

$$ V = \frac{1}{4\pi\sigma}\frac{I}{r} $$

Where $\sigma$ is the conductivity of neural tissue, $I$ is a transmembrane current, and $r$ is the distance between the electrode and the current. A few trends are clear from this equation. A simplifying assumption we make when using this equation is that the the conductivity of the brain is homogenous (sometimes referred to as being Ohmic). Given that, the influence that a transmembrane current has on an electrode will only depend on the the distance the electrode has from the current, and the current's sign and magnitude. The further a current is from the electrode, the weaker it gets, with the greatest fall off happening at short distances. If a current is flowing into the neuron (excitatory), then it will produce a negative voltage at the electrode, while a current flowing out of the neuron (inhibitory) produces a positive voltage. The magnitude of the voltage signal will be linearly proportional to the voltage, e.g. doubling the current will double the voltage.

There are multiple current sources in the brain. Every open ion channel is a potential current source and these carpet the entire neuronal membrane. To capture their collective influence on a recording electrode, we can treat each as producing their own voltage and add them together. 

$$ V = \frac{1}{4\pi\sigma}\sum_{i=0}^{n}\frac{I_i}{r_e - r_i} $$

In this equation we sum the resulting voltages from all currents, with each current $I_i$ divided by its distance from the recording electrode, $r_e - r_i$. Stronger currents will tend to dominate over weaker ones, with 

Voltage/potentials. Poisson's equation, strength of transmembrane currents, distances, Ohmic property of neural tissue.

### Modeling relationship between electrode distance and recorded potential

## Types of recordings

DEPTH ELECTRODE - unit activity and local field potentials

If one opens up the skull and places electrodes directly on the brain surface, then you are recording *electrocorticograms* (ECoG). These are usually performed with an array of circular electrodes embedded in a flexible plastic that can be layed against the cortical surface. The circular electrodes are smaller than those used for EEG, and because they are closer to the neural sources of electrical signals they are better able to pick up localized changes activity immediately below them. 
IMAGE OF ECOG ELECTRODES ON BRAIN SURFACE HERE

There are several different ways to measure electrical brain activity. These different give us access to fundamentally different neural phenomena. Most familiar is the *electroencephalogram* (EEG). This non-invasive method places large (at least several mm in diameter) metal contacts on the scalp with conductive gel sandwiched between. It picks up the average signal, for the most part synaptic, over a relatively large area of the brain. Electrical activity in the brain that reaches these electrodes must pass through several layers of connective tissue, the skull, and the skin, before they can each the scalp electrode. This severly attenuates and distorts the signal.
IMAGE OF EEG ELECTRODE HERE

EEG, ECoG, depth electrodes

### Types of activities
Scalp potentials, surface and local field potentials, unit activity

**Comparison of recording techniques**

| Method | Electrode type | Signals detected | Amplitude range | Advantage|
| -------| --------| -----| -----| ---- |
| EEG | Large metal discs on scalp | Synaptic activities over large areas | ~1-30 uV | Non-invasive |
| ECoG | Small metal discs in array on brain surface | Synaptic activities over small area | | Localized signals|
| Depth | Fine wires or silicon probes| | | |

## Detecting neural activity
It is possible to measure these electrical activities in awake behaving subjects. Doing so requires the use of electrodes and electronic circuitry, like amplifiers and filters, to boost and clean these weak signals. Storing them on a computer requires an analog to digital converter, that turns the amplifiied analog electrical signal into a series of 0s and 1s suitable for storing as a computer file.
